{% extends "layout.html" %}

{% block sidebar_right %}
<div class="my-md-5 py-md-5"></div>
<div class="mb-3">
    <ul class="list-group" id="providerList">
        <!--<li class="list-group-item d-flex justify-content-between align-items-center">
            <div class="custom-control custom-checkbox">
                <input type="checkbox" class="custom-control-input" id="customCheck" name="example1">
                <label class="custom-control-label" for="customCheck">Provider 1</label>
            </div>
            <span class="badge badge-primary badge-proxally badge-pill">12</span>
        </li>-->
    </ul>
</div>
{% endblock %}

{% block sidebar_left %}
<div class="my-md-5 py-md-5"></div>
<div class="jumbotron bg-light">
    <label for="anonymities">Anonymity</label>
    <div id="anonymities">
        <div class="bg-proxyally-light px-3 py-2 mb-2">
            <div class="custom-control custom-checkbox">
                <input type="checkbox" class="custom-control-input" id="transparent" name="transparent" value="Transparent">
                <label class="custom-control-label" for="transparent">Transparent</label>
            </div>
        </div>
        <div class="bg-proxyally-light px-3 py-2 mb-2">
            <div class="custom-control custom-checkbox">
                <input type="checkbox" class="custom-control-input" id="anonymous" name="anonymous" value="Anonymous">
                <label class="custom-control-label" for="anonymous">Anonymous</label>
            </div>
        </div>
        <div class="bg-proxyally-light px-3 py-2 mb-3">
            <div class="custom-control custom-checkbox">
                <input type="checkbox" class="custom-control-input" id="elite" name="elite" value="Elite">
                <label class="custom-control-label" for="elite">Elite</label>
            </div>
        </div>
    </div>

    <label for="protocol">Protocol</label>
    <div id="protocol">
        <div class="bg-proxyally-light px-3 py-2 mb-2">
            <div class="custom-control custom-checkbox">
                <input type="checkbox" class="custom-control-input" id="http" name="http" value="http">
                <label class="custom-control-label" for="transparent">HTTP</label>
            </div>
        </div>
        <div class="bg-proxyally-light px-3 py-2 mb-2">
            <div class="custom-control custom-checkbox">
                <input type="checkbox" class="custom-control-input" id="http" name="http" value="http">
                <label class="custom-control-label" for="anonymous">HTTPS</label>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block content %}
<nav class="navbar navbar-expand-sm navbar-dark bg-proxyally py-1 mb-3">
    <ul class="navbar-nav">
        <li class="nav-item">
            <a class="nav-link text-white" href="#"><i class="fas fa-save"></i> Save As</a>
        </li>
        <li class="nav-item">
            <a class="nav-link text-white" href="#"><i class="fas fa-file-import"></i> Import</a>
        </li>
        <li class="nav-item">
            <a class="nav-link text-white" href="#" onclick="exportProxies()"><i class="fas fa-file-export"></i> Export</a>
        </li>
    </ul>
</nav>
<div class="d-md-flex">
    <div class="flex-fill d-flex my-3">
        <span class="py-1">Show</span>
        <select id="limit" name="limit" class="custom-select w-25 mx-2">
            <option value="5" selected>5</option>
            <option value="10">10</option>
            <option value="15">15</option>
        </select>
        <span class="py-1">entries</span>
    </div>
    <div class="flex-fill my-3 text-md-center">
        <a class="btn" href="#" onclick="$('#dataTable .collapse').collapse('hide')">
            <i class="fas fa-compress-arrows-alt"></i> Minimal
        </a>
        <a class="btn" href="#" onclick="$('#dataTable .collapse').collapse('show')">
            <i class="fas fa-expand-arrows-alt"></i> Expanded
        </a>
    </div>
    <div class="flex-fill my-3">
        <ul class="pagination">
            <!--<li class="page-item ml-md-auto"><a class="page-link" href="#">previous</a></li>
            <li class="page-item"><a class="page-link" href="#">1</a></li>
            <li class="page-item active"><a class="page-link" href="#">2</a></li>
            <li class="page-item"><a class="page-link" href="#">3</a></li>
            <li class="page-item"><a class="page-link" href="#" onclick="next()">Next</a></li>-->
        </ul>
    </div>
</div>

<div class="border">
    <div class="table-responsive-sm">
        <table class="table table-hover" id="dataTable">
            <thead>
                <tr>
                    <th>
                        Proxy
                    </th>
                    <th>
                        Anonymity
                    </th>
                    <th>
                        Last Checked
                    </th>
                    <th>
                        Last Found
                    </th>
                    <th>
                        First Discoverd
                    </th>
                    <th>
                        Provider
                    </th>
                </tr>
            </thead>
            <tbody id="proxyList">
                <tr>
                    <td colspan="6" class="text-md-center py-5">
                        <div class="spinner-border"></div>
                        <br/>Loading Data ...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<div class="d-md-flex">
    <div class="flex-fill my-3">
        Showing <span id="entryStatistics"> x out of N </span> entries
    </div>
    <div class="flex-fill my-3">
        <ul class="pagination">
            <!--<li class="page-item ml-md-auto"><a class="page-link" href="#">Previous</a></li>
            <li class="page-item"><a class="page-link" href="#">1</a></li>
            <li class="page-item active"><a class="page-link" href="#">2</a></li>
            <li class="page-item"><a class="page-link" href="#">3</a></li>
            <li class="page-item"><a class="page-link" href="#" onclick="next()">Next</a></li>-->
        </ul>
    </div>
</div>
{% endblock %}


{% block scripts %}
<script src="/static/lib/datatables/jquery.dataTables.min.js"></script>
<script src="/static/lib/datatables/dataTables.bootstrap4.min.js"></script>
<script>
    var urlApp = 'http://localhost:5000';

    var urlProxies = 'http://localhost:5001/api/v1/proxies';    
    var queryParams = {
        embed: true,
        offset: 0
    };

    function getQueryString() {
        var params = [];
        for (var key in queryParams) {
            var param = key + '=' + queryParams[key]
            params.push(param);
        }
        return params.join('&');
    }

    function showLoading() {
        $('#proxList').html('<tr>'
            + '<td colspan="6" class="py-4 mx-auto">'
            + '<div class="spinner-border text-dark"></div>'
            + '<br />Loading Proxies ...'
            + '</td>'
            + '</tr>');
    }

    function generateProviderCheckboxElement(id, name, proxy_count) {
        checked = proxy_count > 0 ? 'checked' : ''
        checkbox = $('<div class= "custom-control custom-checkbox">'
            + '<input type="checkbox" class="custom-control-input" id="' + id + '" name="' + id + '" value="' + id + '" ' + checked + ' onchange="filterByProvider()">'
            + '<label class="custom-control-label" for="' + id + '">' + name + '</label>'
            + '</div>'
            + '<span class="badge badge-light badge-proxally-light badge-pill">' + proxy_count + '</span>'
        );
        return checkbox;
    }

    function generatePaginationElements(totalCount) {
        var limit = parseFloat($('#limit').val());
        totalCount = parseFloat(totalCount);
        var uls = $('.pagination').html('');

        li = $('<li class="page-item ml-md-auto"><a class="page-link" href="#" onclick="paginate(this, ' + totalCount + ')">Previous</a></li>');
        uls.append(li);

        totalCount = Math.ceil(totalCount / limit) * limit;
        for (var offset = 0; offset < totalCount; offset += limit) {
            li = $('<li class="page-item"><a class="page-link" href="#" onclick="paginate(this, ' + totalCount + ')">' + ((offset / limit) + 1) + '</a></li>');
            uls.append(li);
        }

        li = $('<li class="page-item"><a class="page-link" href="#" onclick="paginate(this, ' + totalCount + ')">Next</a></li>');
        uls.append(li);
    }

    function paginate(pageLink, totalCount) {
        var limit = parseInt($('#limit').val());
        if ($(pageLink).text() === 'Next') {
            console.log(queryParams.offset + limit, totalCount);
            if (queryParams.offset + limit > totalCount - limit) {
                return;
            }
            queryParams.offset += limit;
        } else if ($(pageLink).text() === 'Previous') {
            if (queryParams.offset == 0) {
                return;
            }
            queryParams.offset -= limit;
        }
        else {
            offset = (parseInt($(pageLink).text()) - 1) * limit;
            queryParams.offset = offset;
            $(pageLink).parent().addClass('active');
        }

        $.ajax({
            url: urlProxies + '?' + getQueryString(),
            success: function (data) { populateProxyList(data.items); },
            error: function (err) { window.alert('Error :: ' + err.statusText); }
        });
    }

    function populateProviders(proxies) {
        var ul = $('#providerList').html('')

        providers_flattened = []
        for (var i in proxies)
            providers_flattened.push(proxies[i].provider)

        providers = _.indexBy(providers_flattened, 'id');
        proxy_count = _.countBy(providers_flattened, 'id');
        for (var i in providers) {
            provider = providers[i];
            li = $('<li></li>').addClass('list-group-item d-flex justify-content-between align-items-center')
            li.append(generateProviderCheckboxElement(provider.id, provider.name, proxy_count[i]))
            ul.append(li);
        }
    }

    function populateProxyList(proxies) {
        var tbody = $('#proxyList').html('');
        for (var i in proxies) {
            proxy = proxies[i]
            var row = $('<tr style="cursor: pointer" onclick="$(this).next().collapse(\'toggle\')"></tr>');

            a = $('<a></a>').html('<i class="fas fa-server fa-xs"></i> <b>' + proxy.ip + ':' + proxy.port + '</b>');
            a.attr('href', [urlApp, '/proxy/details/', proxy.id].join(''));
            row.append($('<td></td>').html(a));

            row.append($('<td></td>').text(proxy.anonymity));
            row.append($('<td></td>').text($.timeago(proxy.funcTestDate)));
            row.append($('<td></td>').text($.timeago(proxy.lastFoundDate)));
            row.append($('<td></td>').text($.timeago(proxy.discoveredDate)));

            a = $('<a></a>').text(proxy.provider.name);
            a.attr('href', [urlApp, '/provider/details/', proxy.provider.id].join(''));
            row.append($('<td></td>').html(a));

            tbody.append(row);

            if (proxy.testurls.length) {
                row = $('<tr class="bg-light collapse show"></tr>');
                var col = $('<td colspan="6"></td>');

                var content = '<small>Tested:<br/>';
                for (var j in proxy.testurls) {
                    testurl = proxy.testurls[j];
                    content += $.timeago(proxy.testurls[j].urlFuncTestDate) + ' @ (<a href="' + [urlApp, '/testurl/details/', testurl.id].join('') + '">' + proxy.testurls[j].url + ')</a><br/>';
                }
                content += "</small>";
                col.html(content);
                tbody.append(row.append(col));
            }

        }

        $('#entryStatistics').html(proxies.length + ' out of 14');
        generatePaginationElements(14);
    }

    function populateAnonymity(proxies) {
        anonymities = _.countBy(proxies, 'anonymity');
        $('#anonymities input[type=checkbox]').each(function () {
            this.checked = true ? anonymities[this.value] > 0 : false;
        });
    }

    function populateUi(updateProviderList = true) {
        queryParams.limit = $('#limit').val();
        $.ajax({
            url: urlProxies + '?' + getQueryString(),
            success: function (data) {
                if (updateProviderList)
                    populateProviders(data.items);
                populateProxyList(data.items);
                populateAnonymity(data.items);
            },
            error: function (err) { window.alert('Error :: ' + err.statusText); }
        });
    }

    function filterByProvider() {
        showLoading();

        providers = []
        $('#providerList input:checked').each(function () {
            providers.push($(this).attr('value'));
        });
        queryParams.providers = providers.length ? providers.join(',') : '';

        populateUi(false);
    }

    function exportProxies() {
        var text = "hello world",
            blob = new Blob([text], { type: 'text/plain' }),
            anchor = document.createElement('a');

        anchor.download = "hello.txt";
        anchor.href = (window.webkitURL || window.URL).createObjectURL(blob);
        anchor.dataset.downloadurl = ['text/plain', anchor.download, anchor.href].join(':');
        anchor.click();
    }

    $(function () {
        populateUi();

        $('#anonymities :checkbox').change(function () {
            anonymities = []
            $('#anonymities input:checked').each(function () {
                anonymities.push($(this).attr('value'));
            });
            queryParams.anonymities = anonymities.join(',');
            delete queryParams.providers;

            populateUi();
        });

        $('#limit').change(function () {
            delete queryParams.offset;
            delete queryParams.providers;
            queryParams.limit = $('#limit').val();
            populateUi();
        });
    });
</script>
{% endblock %}
